var totalResolve,totalReject,bestoAuth=!1,staryeaAuth=!1,bestoAuthResult=!1,staryeaAuthResult=!1,terminateRequest=!1;function hkAuth(t,e,s){totalResolve=e,totalReject=s,(isNoNeedClassify()&&"1"===Utility.getValueByName("hkStatus")?doubleAuthParaline:goClassifyCheck)(t)}function doubleAuthParaline(t){var e=t.code;getBestoAuth(e,"",function(t){bestoAuth=!0,2==t&&(bestoAuthResult=!0),bestoAuth&&staryeaAuth&&(bestoAuthResult&&staryeaAuthResult?totalResolve(1):bestoAuthResult||staryeaAuthResult?bestoAuthResult!=staryeaAuthResult&&totalReject(bestoAuthResult?"非常抱歉，业务鉴权失败。GD通过，CT不通过。":"非常抱歉，业务鉴权失败。GD不通过，CT通过。"):totalResolve(0),staryeaAuthResult=bestoAuthResult=staryeaAuth=bestoAuth=!1)},function(t){terminateRequest=bestoAuth=!0,totalReject("百途鉴权服务器异常"),staryeaAuthResult=bestoAuthResult=staryeaAuth=bestoAuth=!1}),getStaryeaAuth(e,function(t){staryeaAuth=!0;var e=parseStaryeaResultDom(t);"true"===e.isCheckResule?"9304"!==e.result&&"0"!==e.result||(staryeaAuthResult=!0):totalReject("星邺数据解析失败"),bestoAuth&&staryeaAuth&&(bestoAuthResult&&staryeaAuthResult?totalResolve(1):bestoAuthResult||staryeaAuthResult?bestoAuthResult!=staryeaAuthResult&&totalReject(bestoAuthResult?"非常抱歉，业务鉴权失败。GD通过，CT不通过。":"非常抱歉，业务鉴权失败。GD不通过，CT通过。"):totalResolve(0),staryeaAuthResult=bestoAuthResult=staryeaAuth=bestoAuth=!1)},function(t){terminateRequest=staryeaAuth=!0,totalReject("星晔鉴权服务器异常"),staryeaAuthResult=bestoAuthResult=staryeaAuth=bestoAuth=!1})}function goClassifyCheck(s){classifyCheck(function(t){var e;classifyResultParse(t.body),"1"===Utility.getValueByName("hkStatus")?doubleAuthParaline(s):(e=(new Date).getTime(),Utility.setValueByName("hkStatus",0),Utility.setValueByName("hkUserToken","null"),Utility.setValueByName("hkTimestamp",e),totalReject("4合1认证失败"))},function(t){var e=(new Date).getTime();Utility.setValueByName("hkStatus",0),Utility.setValueByName("hkUserToken","null"),Utility.setValueByName("hkTimestamp",e),totalReject("4合1认证服务器异常")})}function isNoNeedClassify(){var t=Utility.getValueByName("hkTimestamp"),e=Utility.getValueByName("hkStatus"),s=Utility.getValueByName("hkUserToken");return void 0!==t&&null!=t&&""!==t&&((new Date).getTime()-t<288e5&&("1"===e&&void 0!==e&&null!=e&&""!==e&&void 0!==s&&null!=s&&""!==s))}function classifyCheck(t,e){var s=Utility.getValueByName("MACAddress")||Authentication.CTCGetConfig("MACAddress")||Authentication.CTCGetConfig("System.MACAddress"),a="http://tsnm-hk.snctv.cn:81/i6interface/ActivateTerminalAndAuth?userId="+(Utility.getValueByName("ntvuseraccount")||Authentication.CTCGetConfig("UserID"))+"&mac="+s+"&flatFlg=1",n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(200===n.status?t(n.responseText):e(n.status))},n.open("GET",a,!0),n.send(null)}function classifyResultParse(t){var e,s,a,n=(new DOMParser).parseFromString(t,"text/xml");a=(n&&n.getElementsByTagName("ActivateAndAuthResult")[0]?(e=n.getElementsByTagName("ActivateAndAuthResult")[0].getAttribute("status"),s=n.getElementsByTagName("ActivateAndAuthResult")[0].getAttribute("userToken"),Utility.setValueByName("hkStatus",e),Utility.setValueByName("hkUserToken",s)):(Utility.setValueByName("hkStatus",0),Utility.setValueByName("hkUserToken","null")),(new Date).getTime()),Utility.setValueByName("hkTimestamp",a)}function getBestoAuth(t,e,s,a){var n="http://tsnm-hk.snctv.cn:81/authbilling/authenticationIptv_authority.do?time=1571291935554&riddle=85c8c19fb62e78c530f6ea9e9f38c8c0&programid="+t+"&categoryid="+e+"&temptoken="+Utility.getValueByName("hkUserToken")+"&userid="+Utility.getValueByName("ntvuseraccount"),u=new XMLHttpRequest;u.onreadystatechange=function(){4===u.readyState&&(200===u.status?s(u.responseText):a(u.status))},u.open("GET",n,!0),u.send(null)}function getStaryeaAuth(t,e,s){var a=Utility.getValueByName("ntvuseraccount")||Authentication.CTCGetConfig("UserID"),n=Utility.getValueByName("hkUserToken"),u='<?xml version="1.0" encoding="UTF-8"?><soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ui="http://ui.server.servicegansu.epg.soap.interfaces.sysmp.staryea.com" xmlns:req="http://req.ui.server.servicegansu.epg.soap.interfaces.sysmp.staryea.com"><soapenv:Header/><soapenv:Body><ui:serviceAuth><ui:serviceAuthReq><req:contentID>'+t+"</req:contentID><req:contentType>0</req:contentType><req:ip></req:ip><req:mac></req:mac><req:productID></req:productID><req:serverID></req:serverID><req:spID>spa00003</req:spID><req:timeStamp>"+(new Date).getTime()+"</req:timeStamp><req:transactionID>"+("spa0000301"+(new Date).format("yyyyMMddHHmmss")+get8random()+get8random())+"</req:transactionID><req:userID>"+a+"</req:userID><req:userToken>"+n+"</req:userToken></ui:serviceAuthReq></ui:serviceAuth></soapenv:Body></soapenv:Envelope>",r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&(200===r.status?e(r.responseText):s(r.status))},r.open("POST","http://150.138.11.97:8291/services/ServiceInterface",!0),r.setRequestHeader("Content-Type","text/xml; charset=utf-8"),r.setRequestHeader("SOAPAction",""),r.send(u)}function parseStaryeaResultDom(t){var s={},a=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("serviceAuthReturn")[0];if(null==a||""===a||void 0===a)return s.parseResult=2,s.parseResultStr="解析XML出错",s.isCheckResule="false",s;for(q=0;q<a.childNodes.length;q++){var n=a.childNodes[q];if("ns1:balance"===n.tagName)s.balance=n.textContent;else if("ns2:balance1"===n.tagName)s.balance1=n.textContent;else if("ns3:contentID"===n.tagName)s.contentID=n.textContent;else if("ns4:expiredTime"===n.tagName)s.expiredTime=n.textContent;else if("ns5:ip"===n.tagName)s.ip=n.textContent;else if("ns6:mac"===n.tagName)s.mac=n.textContent;else if("ns7:productID"===n.tagName)s.productID=n.textContent;else if("ns8:productList"===n.tagName){var u=[];for(w=0;w<n.childNodes.length;w++){var r=n.childNodes[w];if("item"===r.tagName){var o={};for(e=0;e<r.childNodes.length;e++){var i=r.childNodes[e];"ns8:autoContiueOption"===i.tagName?o.autoContiueOption=i.textContent:"ns8:fee"===i.tagName?o.fee=i.textContent:"ns8:limitTimes"===i.tagName?o.limitTimes=i.textContent:"ns8:listPrice"===i.tagName?o.listPrice=i.textContent:"ns8:productDesc"===i.tagName?o.productDesc=i.textContent:"ns8:productID"===i.tagName?o.productID=i.textContent:"ns8:productName"===i.tagName?o.productName=i.textContent:"ns8:purchaseType"===i.tagName?o.purchaseType=i.textContent:"ns8:rentalTerm"===i.tagName&&(o.rentalTerm=i.textContent)}u.push(o)}s.productList=u}}else"ns9:purchaseType"===n.tagName?s.purchaseType=n.textContent:"ns10:result"===n.tagName?s.result=n.textContent:"ns11:serverID"===n.tagName?s.serverID=n.textContent:"ns12:stbID"===n.tagName?s.stbID=n.textContent:"ns13:transactionID"===n.tagName?s.transactionID=n.textContent:"ns14:userID"===n.tagName&&(s.userID=n.textContent)}return s.parseResult=1,s.parseResultStr="解析成功",s.isCheckResule="true",s}function get8random(){return(Math.round(89999999*Math.random())+1e7).toString()}Date.prototype.format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"f+":this.getMilliseconds()};for(var s in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,this.getFullYear()+"").substr(4-RegExp.$1.length)),e)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[s]:("00"+e[s]).substr((""+e[s]).length)));return t};