<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>答题活动V6-对话框</title>
    <meta charset="utf-8" name="page-view-size" content="{$size}">

    <link rel="stylesheet" type="text/css" href="__ROOT__/Public/css/{$platformType}/common.css?t={$time}"/>
    <link rel="stylesheet" type="text/css" href="__ROOT__/Public/css/{$platformType}/Activity/ActivityAnswer/V6/dailog.css?t={$time}">

    <!--第三方依赖库-->
    <script type="text/javascript" src="__ROOT__/Public/ThirdParty/js/json2.js?t={$time}"></script>
    <!--公用库-->
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmcommon_v1.0.1.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmajax_v1.0.1.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmcore_v1.0.1.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmmarquee.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmui_v1.0.1.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmintent_v1.0.1.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmui_v1.0.1.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmlog_v1.0.0.js?t={$time}"></script>
    <!--弹窗-->
    <script type="text/javascript" src="__ROOT__/Public/js/Activity/ActivityAnswer/V6/DialogMoreThree.js?t={$time}"></script>
    <!--弹窗规则定义-->
    <script type="text/javascript" src="__ROOT__/Public/js/Activity/ActivityAnswer/PopRule.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/keyboard.js?t={$time}"></script>

    <!--页面跳转-->
    <script type="text/javascript">
        function getCurrentPage() {
            var objCurrent = LMEPG.Intent.createIntent("activity-common-dialog");
            objCurrent.setParam("userId", "{$userId}");
            objCurrent.setParam("inner", "{$inner}");

            return objCurrent;
        }

        /**
         * @func 进行购买操作
         * @param remark 备注字段，补充说明reason。如订购是通过视频播放，则remark为视频名称；如是通过活动，则remark为活动名称。
         * @returns {boolean}
         */
        function jumpBuyVip() {
            var objCurrent = getCurrentPage();

            var objOrderHome = LMEPG.Intent.createIntent("orderHome");
            objOrderHome.setParam("userId", "{$userId}");
            objOrderHome.setParam("directPay", "1");
            objOrderHome.setParam("orderReason", "101");
            objOrderHome.setParam("remark", "{$activityName}");

            var objActivityGuide = LMEPG.Intent.createIntent("activity-common-guide");
            objActivityGuide.setParam("userId", "{$userId}");
            objActivityGuide.setParam("inner", "{$inner}");

            LMEPG.Intent.jump(objOrderHome, objCurrent, LMEPG.Intent.INTENT_FLAG_DEFAULT, objActivityGuide);
        }

        /**
         * 页面跳转 - 奖品页
         */
        function jumpPirzeDialog(context, prizeIdx, prizeName) {
            var objCurrent = getCurrentPage();
            var objDialog = LMEPG.Intent.createIntent("activity-common-dialog");
            objDialog.setParam("userId", "{$userId}");
            objDialog.setParam("inner", "{$inner}");
            objDialog.setParam("leftTimes", "{$leftTimes}");
            objDialog.setParam("context", context);
            objDialog.setParam("prizeName", prizeName);
            objDialog.setParam("prizeIdx", prizeIdx);
            objDialog.setParam("bg", "play");

            LMEPG.Intent.jump(objDialog, objCurrent, LMEPG.Intent.INTENT_FLAG_NOT_STACK);
        }

        /**
         * 页面跳转 - 游戏主界面
         */
        function jumpPlayUI() {
            var objCurrent = getCurrentPage();

            var objActivityHome = LMEPG.Intent.createIntent("activity-common-home");
            objActivityHome.setParam("userId", "{$userId}");
            objActivityHome.setParam("inner", "{$inner}");

            LMEPG.Intent.jump(objActivityHome, objCurrent, LMEPG.Intent.INTENT_FLAG_NOT_STACK);
        }

    </script>

    <script type="text/javascript" src="__ROOT__/Public/{$platformType}/js/Common/keyWord.js?t={$time}"></script>
</head>
<body>
<div id="dialog">

</div>
<script type="text/javascript">
    var keyWordX = '<?php echo ($platformType === "hd" ? 450 : 145)?>';//呼出键盘的X坐标
    var keyWordY = '<?php echo ($platformType === "hd" ? 550 : 400)?>';//呼出键盘的Y坐标
    var searchTextTips = "请输入有效的电话号码"; //搜索框中的文字提示
    var isVip = {$isVip}; // 是否是vip（0-非vip 1-vip）
    var context = "{$context}";
    var platformType = "{$platformType}";
    var buttons;
    var prizeName = "{$prizeName}"; // 奖品名称
    var prizeIdx = "{$prizeIdx}"; // 奖品id

    function onBack() {
        LMEPG.Intent.back("activity-common-guide");
    }

    function initBtn(num) {
        if (num == 1) {
            buttons = [
                {
                    id: 'btn-one',
                    name: '操作一',
                    type: 'img',
                    nextFocusLeft: '',
                    nextFocusRight: 'btn-two',
                    nextFocusUp: 'back',
                    nextFocusDown: '',
                    backgroundImage: '',
                    focusImage: '',
                    click: "onClick('btn-one')",
                    focusChange: "",
                    beforeMoveChange: "",
                    moveChange: "",
                }
            ];
        } else if (num == 2) {
            var btnUrl1 = G("btn-one").getAttribute('onfocusurl');
            var btnUrlConfirm1 = G("btn-one").getAttribute('confirmurl');
            var btnUrl2 = G("btn-two").getAttribute('onfocusurl');
            var btnUrlConfirm2 = G("btn-two").getAttribute('confirmurl');
            buttons = [
                {
                    id: 'btn-one',
                    name: '操作一',
                    type: 'img',
                    nextFocusLeft: 'btn-two',
                    nextFocusRight: 'btn-two',
                    nextFocusUp: 'back',
                    nextFocusDown: '',
                    backgroundImage: '' + btnUrlConfirm1 + '',
                    focusImage: '' + btnUrl1 + '',
                    click: "onClick('btn-one')",
                    focusChange: "",
                    beforeMoveChange: "",
                    moveChange: "",
                },
                {
                    id: 'btn-two',
                    name: '操作二',
                    type: 'img',
                    nextFocusLeft: 'btn-one',
                    nextFocusRight: 'btn-one',
                    nextFocusUp: 'back',
                    nextFocusDown: '',
                    backgroundImage: '' + btnUrlConfirm2 + '',
                    focusImage: '' + btnUrl2 + '',
                    click: "onClick('btn-two')",
                    focusChange: "",
                    beforeMoveChange: "",
                    moveChange: "",
                }
            ];
        } else {
            var btnUrl1 = G("btn-one").getAttribute('onfocusurl');
            var btnUrlConfirm1 = G("btn-one").getAttribute('confirmurl');
            var btnUrl2 = G("btn-two").getAttribute('onfocusurl');
            var btnUrlConfirm2 = G("btn-two").getAttribute('confirmurl');
            buttons = [
                {
                    id: 'btn-one',
                    name: '操作一',
                    type: 'img',
                    nextFocusLeft: 'btn-two',
                    nextFocusRight: 'btn-two',
                    nextFocusUp: 'searchText',
                    nextFocusDown: '',
                    backgroundImage: '' + btnUrlConfirm1 + '',
                    focusImage: '' + btnUrl1 + '',
                    click: "onClick('btn-one')",
                    focusChange: "",
                    beforeMoveChange: "",
                    moveChange: "",
                },
                {
                    id: 'btn-two',
                    name: '操作二',
                    type: 'img',
                    nextFocusLeft: 'btn-one',
                    nextFocusRight: 'btn-one',
                    nextFocusUp: 'back',
                    nextFocusDown: '',
                    backgroundImage: '' + btnUrlConfirm2 + '',
                    focusImage: '' + btnUrl2 + '',
                    click: "onClick('btn-two')",
                    focusChange: "",
                    beforeMoveChange: "",
                    moveChange: "",
                },
                {
                    id: 'searchText',
                    name: '号码框',
                    type: 'img',
                    nextFocusLeft: '',
                    nextFocusRight: '',
                    nextFocusUp: '',
                    nextFocusDown: 'submit',
                    backgroundImage: '',
                    focusImage: '',
                    click: "",
                    focusChange: "KeyBtn.init(keyWordY, keyWordX, 'searchText', 'btn-one')",
                    beforeMoveChange: "onCommonMoveChange",
                    moveChange: "",
                }
            ];
        }

    }

    window.onload = function (ev) {
        console.log('--->>>left-times:{$leftTimes}');
        if (context == VIP_USER_PLAY_TIMES_OVER) {
            // 会员次数用尽
            dialogCreateTime.show(platformType);
            initBtn(1);
        } else if (context == NOT_VIP_USER_PLAY_TIMES_OVER) {
            //非会员次数用尽
            dialogCreateUnVip.show(platformType);
            initBtn(2);
        } else if (context == ACTIVITY_RULE_DETAIL) {
            //活动规则
            dialogCreateActivity.show(platformType);
            initBtn(1);
        } else if (context == VIP_USER_DRAWN_PRIZE) {
            //中奖
            dialogCreatePhone.show(platformType, prizeName);
            initBtn(3);
        } else if (context == USER_NOT_DRAWN_PRIZE_TIPS) {
            //未中奖
            canAnswer();
            return;
        } else if (context == ANSWER_SUCCESS) {
            //答题成功
            dialogCreateSuccess.show(platformType);
            initBtn(1);
        } else if (context == ANSWER_ERROR) {
            //答题失败,先判断是否还可以答题
            canAnswer();
            return;
        }
        LMEPG.ButtonManager.init(['btn-one'], buttons, '', true);
    }

    /**
     * 点击事件
     */
    function onClick(btnId) {
        if (focusType == "back") {
            onBack();
        } else if (focusType == "book") {
            //订购页
            if (btnId == "btn-one") {
                jumpBuyVip();
            } else if (btnId == "btn-two") {
                onBack();
            }
        } else if (focusType == "open") {
            participationActivity();
        } else if (focusType == "save") {
            //填写手机号码页面
            if (btnId == "btn-one") {
                //去设置电话号码
                goSetPhoneNumber();
            } else if (btnId == "btn-two") {
                onBack();
            }
        } else if( focusType== "continueAnswer"){
            // 继续答题
            jumpPlayUI();
        }
    }

    //参与抽奖
    function participationActivity() {
        if (LMEPG.Func.isAllowAccess(isVip, ACCESS_NO_TYPE)) {
            LMEPG.ajax.postAPI('Activity/participateActivity', null,
                function (rsp) {
                    var context = 0;
                    var prizeName = "";
                    var prizeIdx = 0;

                    try {
                        var data = rsp instanceof Object ? rsp : JSON.parse(rsp);
                        var result = data.result;
                        if (result == 0) {
                            //没有抽中奖品
                            context = USER_NOT_DRAWN_PRIZE_TIPS;
                        } else if (result == 1) {
                            //抽中奖品
                            context = VIP_USER_DRAWN_PRIZE;
                            prizeName = data.prize_name;
                            prizeIdx = data.prize_idx;
                        } else if (result == -108) {
                            //vip参与活动次数已满
                            context = VIP_USER_PLAY_TIMES_OVER;
                        } else if (result == -109) {
                            //非会员试玩后提示
                            context = NOT_VIP_USER_PLAY_TIMES_OVER;
                        } else {
                            LMEPG.UI.showToast("打开宝箱出错:" + result, 3);
                            setTimeout(function () {
                                LMEPG.Intent.back();
                            }, 3000);
                            return;
                        }
                    } catch (e) {
                        LMEPG.UI.showToast("网络异常！", 3);
                        LMEPG.Log.error(e.toString());
                    }
                    jumpPirzeDialog(context, prizeIdx, prizeName);
                },
                function (rsp) {
                    LMEPG.UI.showToast("请求抽奖发生错误！");
                }
            );
        } else {
            // 应产品要求：宁夏电信EPG答题活动，对 [普通用户] 而言，无论如何不能中奖。
            // 故此，只模拟抽奖过程并非真正去调用抽奖接口（目前后台抽奖接口并无选择VIP和非VIP能否中奖）
            // ----- 修改于 2018-10-26 10:13:29 宋辉
            console.error('--->Non-VIP[640092-宁夏电信] user cannot drawn a prize!');
            LMEPG.UI.showWaitingDialog('', 1.5, function () {
                LMEPG.UI.dismissWaitingDialog();
                jumpPirzeDialog(USER_NOT_DRAWN_PRIZE_TIPS, "", 0);
            });
        }
    }

    /**
     * 去设置中奖电话号码
     */
    function goSetPhoneNumber() {
        //获取用户填写的手机号
        var phoneTex = G("searchText");
        var userTel = phoneTex.innerHTML;
        var myPrices = '<?php echo $prizeName?>';
        var prizeIdx = '<?php echo $prizeIdx?>';
        if (prizeIdx == null) {
            LMEPG.UI.showToast("没有中奖！", 3);
            return;
        }
        if (!LMEPG.Func.isTelPhoneMatched(userTel)) {
            LMEPG.UI.showToast("请填写正确的手机号！", 3);
            return;
        }

        var reqData = {
            "phoneNumber": userTel,
            "prizeIdx": prizeIdx
        };
        LMEPG.ajax.postAPI('Activity/setPhoneNumber', reqData,
            function (rsp) {
                try {
                    var data = rsp instanceof Object ? rsp : JSON.parse(rsp);
                    var result = data.result;
                    if (result == 0) {  // 设置号码成功
                        LMEPG.UI.showToast("提交成功", 1);
                        setTimeout(function () {
                            onBack();
                        }, 1000);
                    } else { // 设置号码失败
                        LMEPG.UI.showToast("提交失败，请重试！");
                    }
                } catch (e) {
                    LMEPG.UI.showToast("保存手机号结果处理异常！");
                    LMEPG.Log.error(e.toString());
                }
            },
            function (rsp) {
                LMEPG.UI.showToast("请求保存手机号发生错误！");
            }
        );
    }

    /**
     * 判断用户是否可以答题
     */
    function canAnswer() {
        LMEPG.ajax.postAPI('Activity/canAnswer', null,
            function (rsp) {
                try {
                    var data = rsp instanceof Object ? rsp : JSON.parse(rsp);
                    var canAnswer = data.result == 0 && data.leftTimes > 0;
                    if (canAnswer) {
                        //可以答题
                        //还可以答题
                        if(context == ANSWER_ERROR){
                            dialogCreateFalse.show(platformType,true);
                        } else if(context == USER_NOT_DRAWN_PRIZE_TIPS) {
                            dialogNoPrice.show(platformType,true);
                        }
                    } else {
                        //不可以答题
                        if(context == ANSWER_ERROR){
                            dialogCreateFalse.show(platformType,false);
                        } else if(context == USER_NOT_DRAWN_PRIZE_TIPS) {
                            dialogNoPrice.show(platformType,false);
                        }
                    }
                    initBtn(1);
                    LMEPG.ButtonManager.init(['btn-one'], buttons, '', true);
                } catch (e) {
                    LMEPG.UI.showToast("判断用户是否可以答题，解析异常！", 3);
                    LMEPG.Log.error(e.toString());
                }
            },
            function (rsp) {
                LMEPG.ButtonManager.init('btn-one', buttons, '', true); // 失败异常处理，保证至少可以响应返回按键
                LMEPG.UI.showToast("判断用户是否可以答题失败", 3);
            }
        );
    }

</script>
</body>
</html>