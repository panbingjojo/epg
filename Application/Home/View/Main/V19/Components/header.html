<div id="header-container">
    <div id="top-action-content-icons">
        <img id="search" src="__ROOT__/Public/img/hd/Home/V13/Home/search.png">
        <img id="mark" src="__ROOT__/Public/img/hd/Home/V13/Home/mark.png">
        <img id="vip" src="__ROOT__/Public/img/hd/Home/V13/Home/vip.png">
        <img id="set" src="__ROOT__/Public/img/hd/Home/V13/Home/set.png">
        <img id="help" src="__ROOT__/Public/img/hd/Home/V13/Home/help.png">
        <if condition="$showPayLock eq 1">
            <if condition="$payLockStatus eq 1">
                <img id="lock" src="__ROOT__/Public/img/hd/Home/V13/Home/lock_open.png">
                <else/>
                <img id="lock" src="__ROOT__/Public/img/hd/Home/V13/Home/lock_close.png">
            </if>
        </if>
    </div>
    <div id="nav-content-tabs"></div>
</div>

<script type="text/javascript">

    var thisNavID; // 跳转记录当前导航条焦点
    var navIsLeave; // 导航条是否离开
    var previousTabIndex; // 上一个导航焦点
    var callbackOnce = true; // 声明执行一次函数
    var smallVideoTimer = null; // 小窗播放定时器
    var getJumpKeepFocusTabId = LMEPG.Func.getLocationString('tabId');  // 得到跳转页面回来的tab焦点
    var pathPrefix = '/Public/img/hd/Home/V13/Home/';

    /*导航栏得失焦点回调操作*/
    function tabGetFocus(btn, hasFocus) {
        // 当前导航条的索引
        var currentTabIndex = btn.id.slice(-1);
        if (hasFocus) {
            // 启动当前内容块轮播
            startTimer(currentTabIndex);
            // 重置小窗播放的内容块
            reBuildSmallVideo(currentTabIndex);
            // 调用内容块控制器
            tabContentController(currentTabIndex);
            // 设置不同内容块背景图
            setBodyBackgroundImage(currentTabIndex);
            // 初始化变量
            initializationVariable(btn);
            // 首次进入执行帮助图文
            HelpModal.showTabHelp(currentTabIndex);
        } else {
            tabLoseFocus(btn, currentTabIndex);
        }
        toggleFocus(btn, hasFocus);
    }

    /*销毁/重启小窗播放*/
    function reBuildSmallVideo(index) {
        if (RenderParam.carrierId == '210092' || RenderParam.carrierId == '370092') {
            return;
        }
        clearInterval(smallVideoTimer);
        if (!+index) {
            if (index == previousTabIndex) return;
            // 每次加载Tab0页面，开启小窗播放
            Play.startPollPlay();
        } else {
            smallVideoTimer = setInterval(function () {
                LMEPG.mp.destroy();
            }, 100);
            // 江苏电信华为盒子(EC6110T_pub_jssdx)释放小窗播放方式
            if (RenderParam.stbModel === 'EC6110T_pub_jssdx' ||
                RenderParam.stbModel === 'EC6108V9_pub_jssdx') {
                G('iframe_small_screen').src =g_appRootPath+ '/Public/img/Common/spacer.gif';
            }
        }
    }

    /*内容块显隐控制器*/
    function tabContentController(index) {
        var isShowDisplay = G('content-' + index).style.display;
        if (isShowDisplay === 'none' || !isShowDisplay) {
            Hide('content-' + previousTabIndex); // 隐藏上一个tabContent
            Show('content-' + index); // 显示当前tabContent
        }
    }

    /*导航栏失去焦点*/
    function tabLoseFocus(btn, index) {
        // 焦点离开导航设置焦点保持
        onceFn();
        previousTabIndex = index;
        if (navIsLeave) {
            G(btn.id).src = RenderParam.fsUrl + RenderParam.navConfig[index].img_url.focus_out;
        }
    }

    /*得到焦点初始化*/
    function initializationVariable(btn) {
        thisNavID = btn.id; // 标记当前焦点的ID
        HelpModal.count = 0; // 初始话当前帮助索引为零
        navIsLeave = false; // 导航得到焦点标记离开状态为false
    }

    /*为不同tab设置不同背景图，主要是tab0有小窗，背景图为镂空的*/
    function setBodyBackgroundImage(index) {
        var imgPrefix = g_appRootPath+'/Public/img/{$platformType}/Home/V13/Home/';
        var TP = RenderParam;
        var bgObj = RenderParam.tabBg;
        // 焦点在本栏目内容区移到自身tab 不需要做背景图的渲染
        if (index == previousTabIndex) return;
        //+--------------------主页的背景图设置规则----------------------
        //优先级：系统配置背景图>自定义皮肤>默认
        //+-------------------------------------------------------------
        var tabStrIndex = 'tab' + (parseInt(index) + 1);
        var bgImg = imgPrefix + 'bg.png';

        if (bgObj[tabStrIndex]) {
            bgImg = TP.fsUrl + bgObj[tabStrIndex];
        } else if (TP.skin['sy'] || TP.skin['cpbjt']) {
            bgImg = index == 0 ? TP.fsUrl + TP.skin.sy : TP.fsUrl + TP.skin.cpbjt;
        } else {
            index == 0 ? bgImg = (imgPrefix + 'bg_home.png') : null;
        }
        document.body.style.backgroundImage = 'url(' + bgImg + ')';
    }

    /*启动轮播*/
    function startTimer(currentTabIndex) {
        clearInterval(Tab1.Carousel.timer);
        clearInterval(Tab0.Carousel.timer);
        if (currentTabIndex == 0) {
            Tab0.Carousel.init();
        }
        if (currentTabIndex == 1) {
            Tab1.Carousel.init();
        }
    }

    /*通用切换*/
    function toggleFocus(btn, hasFocus) {
        var btnElement = G(btn.id);
        if (hasFocus) {
            btnElement.setAttribute('class', 'focus');
        } else {
            btnElement.removeAttribute('class');
        }
    }

    /*小图标功能区得失焦点*/
    function onFocusIn(btn, hasFocus) {
        toggleFocus(btn, hasFocus);
        initDownFocusObj(btn);
    }

    /*小图标下移（搜索左移动）到当前对应内容块导航焦点上*/
    function initDownFocusObj(btn) {
        LMEPG.BM.getButtonById(btn.id).nextFocusDown = 'tab-' + previousTabIndex;
        if (btn.id == 'search') {
            LMEPG.BM.getButtonById('search').nextFocusLeft = 'tab-' + previousTabIndex;
        }
    }

    /*导航栏焦点移动之前*/
    function setTabLeaveStatus(key, btn) {
        var nextFocusId = 'nextFocus' + key.slice(0, 1).toUpperCase() + key.slice(1);
        var btnObj = G(btn[nextFocusId]);
        if (btnObj) {
            // 导航栏向上、下移动设置离开状态
            if (key == 'up' || key == 'down') {
                navIsLeave = true;
            } else {
                getJumpKeepFocusTabId = false; // 其他页面不是通过返回操作跳转回来初始化该参数
            }
        }
    }

    /*只执行一次函数*/
    function onceFn() {
        if (callbackOnce && getJumpKeepFocusTabId) {
            navIsLeave = true;
            callbackOnce = false;
            previousTabIndex = getJumpKeepFocusTabId.slice(-1);
        }
    }

    /*获取当前页*/
    function getCurPageObj() {
        var objCurrent = LMEPG.Intent.createIntent('home');
        objCurrent.setParam('focusId', LMEPG.BM.getCurrentButton().id);
        objCurrent.setParam('tabId', thisNavID);
        objCurrent.setParam('bottomPage', +Tab1.bottomPage);
        return objCurrent;
    }

    /*小图标跳转页面*/
    function jumpPageUI(btn) {
        var currentObj = getCurPageObj(btn);
        // 通过点击对象id,设置跳转页面对象
        var jumpPageObj = {
            'search': 'search',
            'mark': 'dateMark',
            'vip': 'orderHome',
            'set': 'custom',
            'help': 'helpIndex'
        };
        var jumpAgreementObj = LMEPG.Intent.createIntent(jumpPageObj[btn.id]);
        // 跳转的订购页面
        if (jumpPageObj[btn.id] == 'orderHome') {
            if (LMEPG.Func.isAllowAccess(RenderParam.isVip, ACCESS_NO_TYPE)) {
                modal.commonDialog({
                    beClickBtnId: btn.id,
                    onClick: modal.hide
                }, '<span style="color: #ef6188">您已是VIP会员，不能重复订购</span>', '海量健康资讯', '为您的家人健康保驾护航');
                return;
            } else {
                jumpAgreementObj.setParam('userId', RenderParam.userId);
                jumpAgreementObj.setParam('isPlaying', '0');
                jumpAgreementObj.setParam('remark', '主动订购');
            }
        }
        LMEPG.Intent.jump(jumpAgreementObj, currentObj);
    }

    /*点击童锁*/
    function lockBeClick() {
        if (RenderParam.payLockStatus == "0") {
            // 童锁未开启，开启童锁
            var postData = {
                'flag': 1,
                'focusIndex': 'lock',
                'returnPageName': "home"
            };
            LMEPG.ajax.postAPI("Pay/getPayLockSetUrl", postData, function (data) {
                if (data.result == 0) {
                    window.location.href = data.url;
                }
            });
            return;
        }
        if (RenderParam.payLockStatus == "1") {
            // 童锁已开启，关闭童锁
            var postData = {
                'flag': 0,
                'focusIndex': 'lock',
                'returnPageName': "home"
            };
            LMEPG.ajax.postAPI("Pay/getPayLockSetUrl", postData, function (data) {
                if (data.result == 0) {
                    window.location.href = data.url;
                }
            });
            return;
        }
        // 查询童锁的状态异常。
    }

    var buttons = [
        {
            id: 'search',
            name: '搜索图标',
            type: 'img',
            nextFocusLeft: 'tab-3',
            nextFocusRight: 'mark',
            nextFocusDown: 'tab-0',
            backgroundImage: pathPrefix + 'search.png',
            focusImage: pathPrefix + 'search_f.png',
            click: jumpPageUI,
            focusChange: onFocusIn
        }, {
            id: 'mark',
            name: '签到图标',
            type: 'img',
            nextFocusLeft: 'search',
            nextFocusRight: 'vip',
            nextFocusDown: 'tab-0',
            backgroundImage: pathPrefix + 'mark.png',
            focusImage: pathPrefix + 'mark_f.png',
            click: jumpPageUI,
            focusChange: onFocusIn
        }, {
            id: 'vip',
            name: 'VIP图标',
            type: 'img',
            nextFocusLeft: 'mark',
            nextFocusRight: 'set',
            nextFocusDown: 'tab-0',
            backgroundImage: pathPrefix + 'vip.png',
            focusImage: pathPrefix + 'vip_f.png',
            click: jumpPageUI,
            focusChange: onFocusIn
        }, {
            id: 'set',
            name: '设置图标',
            type: 'img',
            nextFocusLeft: 'vip',
            nextFocusRight: 'help',
            nextFocusDown: 'tab-0',
            backgroundImage: pathPrefix + 'set.png',
            focusImage: pathPrefix + 'set_f.png',
            click: jumpPageUI,
            focusChange: onFocusIn
        }, {
            id: 'help',
            name: '帮助图标',
            type: 'img',
            nextFocusLeft: 'set',
            nextFocusRight: RenderParam.showPayLock == 1 ? 'lock' : '',
            nextFocusUp: '',
            nextFocusDown: 'tab-0',
            backgroundImage: pathPrefix + 'help.png',
            focusImage: pathPrefix + 'help_f.png',
            click: jumpPageUI,
            focusChange: onFocusIn
        }, {
            id: 'lock',
            name: '童锁图标',
            type: 'img',
            nextFocusLeft: 'help',
            nextFocusRight: '',
            nextFocusUp: '',
            nextFocusDown: 'tab-0',
            backgroundImage: RenderParam.payLockStatus == 1 ? pathPrefix + 'lock_open.png' : pathPrefix + 'lock_close.png',
            focusImage: RenderParam.payLockStatus == 1 ? pathPrefix + 'lock_open_f.png' : pathPrefix + 'lock_close_f.png',
            click: lockBeClick,
            focusChange: onFocusIn
        }, {
            id: 'tab-0',
            name: '第一个导航',
            type: 'img',
            nextFocusLeft: 'tab-3',
            nextFocusRight: 'tab-1',
            nextFocusUp: 'search',
            nextFocusDown: 'video-TV',
            backgroundImage: RenderParam.fsUrl + RenderParam.navConfig[0].img_url.normal,
            focusImage: RenderParam.fsUrl + RenderParam.navConfig[0].img_url.focus_in,
            focusChange: tabGetFocus,
            beforeMoveChange: setTabLeaveStatus
        },
        {
            id: 'tab-1',
            name: '第二个导航',
            type: 'img',
            nextFocusLeft: 'tab-0',
            nextFocusRight: 'tab-2',
            nextFocusUp: 'search',
            nextFocusDown: 'tab1-link',
            backgroundImage: RenderParam.fsUrl + RenderParam.navConfig[1].img_url.normal,
            focusImage: RenderParam.fsUrl + RenderParam.navConfig[1].img_url.focus_in,
            focusChange: tabGetFocus,
            beforeMoveChange: setTabLeaveStatus
        },
        {
            id: 'tab-2',
            name: '第三个导航',
            type: 'img',
            nextFocusLeft: 'tab-1',
            nextFocusRight: 'tab-3',
            nextFocusUp: 'search',
            nextFocusDown: 'sift-2',
            backgroundImage: RenderParam.fsUrl + RenderParam.navConfig[2].img_url.normal,
            focusImage: RenderParam.fsUrl + RenderParam.navConfig[2].img_url.focus_in,
            focusChange: tabGetFocus,
            beforeMoveChange: setTabLeaveStatus
        },
        {
            id: 'tab-3',
            name: '第四个导航',
            type: 'img',
            nextFocusLeft: 'tab-2',
            nextFocusRight: '',
            nextFocusUp: 'search',
            nextFocusDown: 'tab3-link-1',
            backgroundImage: RenderParam.fsUrl + RenderParam.navConfig[3].img_url.normal,
            focusImage: RenderParam.fsUrl + RenderParam.navConfig[3].img_url.focus_in,
            focusChange: tabGetFocus,
            beforeMoveChange: setTabLeaveStatus
        },
        {
            id: 'debug',
            name: '脚手架ID',
            type: 'others',
            click: HelpModal.showTabHelp,
            beforeMoveChange: HelpModal.showTabHelp
        }];
</script>