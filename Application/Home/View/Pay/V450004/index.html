<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>广西广电EPG-订购页</title>
    <meta charset="utf-8" name="page-view-size" content="$size">

    <link rel="stylesheet" type="text/css" href="__ROOT__/Public/css/Common/pay/V1/common.css?t={$time}"/>
    <link rel="stylesheet" type="text/css" href="__ROOT__/Public/css/hd/Pay/V450004/pay.css?t={$time}">

    <!--全局渲染参数-->
    <script type="text/javascript">
        var videoInfo = {$videoInfo};
        var ROOT = "__ROOT__";
        var RenderParam = {
            // 共用参数
            carrierId: "{$carrierId}",          // 地区id
            areaCode: "{$areaCode}",            // 省份地区码
            platformType: "{$platformType}",    // 平台类型
            debug: "{$debug}",                  // 调试模式
            pageSize: "{$size}",                // 页面尺寸
            stbModel: "{$stbModel}",            // 盒子的型号
            fsUrl: "{$resourcesUrl}",           // fs 地址
            time: "{$time}",                    // 开始渲染时间
            userId: "{$userId}",                // 用户Id
            accountId: "{$accountId}",          // 用户账号
            // 页面参数
            orderItems: {$orderItems},
            returnPageName: "{$returnPageName}",
            isPlaying: "{$isPlaying}",
            orderReason: "{$orderReason}",
            remark: "{$remark}",
            videoInfo: videoInfo
        };
    </script>

    <!--第三方依赖库-->
    <script type="text/javascript" src="__ROOT__/Public/ThirdParty/js/json2.js?t={$time}"></script>
    <!--公用库-->
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmcommon.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/lmui_v1.0.1.js?t={$time}"></script>
    <script type="text/javascript" src="__ROOT__/Public/Common/js/android.js?t={$time}"></script>

<body style="background-image: url('__ROOT__/Public/img/hd/Pay/V450004/bg.png');">

<div id="center"></div>
<div>
    <img id="arrow-left" class="arrow" src="__ROOT__/Public/img/hd/Pay/V450004/arrow_l.png"/>
    <img id="arrow-right" class="arrow" src="__ROOT__/Public/img/hd/Pay/V450004/arrow_r.png"/>
</div>
<div id="no-data">暂无可订购项！</div>

<script type="text/javascript">
    var buttons = [];

    /**
     * 返回处理
     */
    function onBack() {
        LMEPG.Intent.back();
    }

    //前端开发处理部分
    var UIHandle = {
        count: 4,   //每页显示多少条
        pageCurrent: 1,//当前页码
        pageTotal: 0, //总共多少页
        isNextTurnPage: true,//是否翻下一页,
        isFirstLoad: true, //是否是第一次加載,
        imgUrl: "__ROOT__/Public/img/hd/Pay/V450004/",
        eleList: {
            noData: G("no-data"),   //没有数据
            arrowNext: G("arrow-right"),   //上一页箭头
            arrowPre: G("arrow-left")      //下一页箭头
        },
        cut: function () {   // 翻页数据截取
            var arr = DataHandle.InitData.OrderItem;
            var atMove = (this.pageCurrent - 1) * this.count;
            return arr.slice(atMove, atMove + this.count);
        },
        createHtml: function (data) {   //创建html元素
            var htmlStr = "";
            UIHandle.pageTotal = Math.ceil(data.length / this.count);

            var dataList = UIHandle.cut();
            for (var i = 0; i < dataList.length; i++) {
                var tempCurrentId = "focus-2-" + (i + 1);
                var tempLeftId = "focus-2-" + (i);
                var tempRightId = "focus-2-" + (i + 2);
                var tempImg = ""; //未选中图片
                var tempImgF = ""; //选中图片
                switch (dataList[i].price) {
                    case "2000":
                        tempImg = UIHandle.imgUrl + "20.png";
                        tempImgF = UIHandle.imgUrl + "20f.png";
                        break;
                    case "6000":
                        tempImg = UIHandle.imgUrl + "60.png";
                        tempImgF = UIHandle.imgUrl + "60f.png";
                        break;
                    case "500":
                        tempImg = UIHandle.imgUrl + "5.png";
                        tempImgF = UIHandle.imgUrl + "5f.png";
                        break;
                    case "9600":
                        tempImg = UIHandle.imgUrl + "96.png";
                        tempImgF = UIHandle.imgUrl + "96f.png";
                        break;
                    case "16800":
                        tempImg = UIHandle.imgUrl + "168.png";
                        tempImgF = UIHandle.imgUrl + "168f.png";
                        break;
                    case "21600":
                        tempImg = UIHandle.imgUrl + "216.png";
                        tempImgF = UIHandle.imgUrl + "216f.png";
                        break;
                }
                if (!tempImg) continue;
                htmlStr += '<img id="' + tempCurrentId + '" class="tab1" src="' + tempImg + '"/>';

                buttons.push({
                    id: tempCurrentId,
                    name: '数据归档',
                    type: 'div',
                    nextFocusLeft: tempLeftId,
                    nextFocusRight: tempRightId,
                    nextFocusUp: '',
                    nextFocusDown: '',
                    backgroundImage: tempImg,
                    focusImage: tempImgF,
                    click: this.onClick,
                    focusChange: "",
                    beforeMoveChange: UIHandle.onBeforeMoveChange,
                    cOrderItemObj: dataList[i]
                });

            }
            G("center").innerHTML = htmlStr;
            UIHandle.updateMenuArrows();
            if (this.isFirstLoad) {
                this.isFirstLoad = false;
                LMEPG.ButtonManager.init("focus-2-1", buttons, '', true);
            } else {
                if (this.isNextTurnPage) {
                    LMEPG.ButtonManager.init('focus-2-1', buttons, '', true);
                } else {
                    LMEPG.ButtonManager.init('focus-2-4', buttons, '', true);
                }
            }
        },
        nextPage: function () {
            if (UIHandle.pageCurrent < UIHandle.pageTotal) {
                UIHandle.pageCurrent++;
                this.isNextTurnPage = true;
                UIHandle.createHtml(DataHandle.InitData.OrderItem);
            }
        },
        prevPage: function () {
            if (UIHandle.pageCurrent > 1) {
                UIHandle.pageCurrent--;
                this.isNextTurnPage = false;
                UIHandle.createHtml(DataHandle.InitData.OrderItem);
            } else {
                return false;
            }
        },

        updateMenuArrows: function () {
            this.eleList.arrowNext.style.display = "none";
            this.eleList.arrowPre.style.display = "none";
            if (UIHandle.pageCurrent > 1) {
                this.eleList.arrowPre.style.display = "block";
            }
            if (UIHandle.pageCurrent < UIHandle.pageTotal) {
                this.eleList.arrowNext.style.display = "block";
            }
        },
        onBeforeMoveChange: function (dir, current) {  // 推荐位按键移动
            switch (dir) {
                case 'left':
                    if (current.id == "focus-2-1") {
                        UIHandle.prevPage();
                        return false;
                    } else {
                    }
                    break;
                case 'right':
                    if (current.id == "focus-2-4") {
                        UIHandle.nextPage();
                        return false;
                    }
                    break;
            }
        },
        departFocus: function (btn, hasFocus) {
            if (hasFocus) {
                LMEPG.CssManager.addClass(btn.id, "btn-hover");
            } else {
                LMEPG.CssManager.removeClass(btn.id, "btn-hover");
            }
        },
        onClick: function (btn) {
            var orderItemObj = btn.cOrderItemObj;
            var payInfo = {
                "vip_id": orderItemObj.vip_id,
                "price": orderItemObj.price,//订购价格，用于区分
                "userId": RenderParam.userId,
                "isPlaying": RenderParam.isPlaying,
                "orderReason": RenderParam.orderReason,
                "remark": RenderParam.remark,
                "returnUrl": "",
                "returnPageName": RenderParam.returnPageName,
            };
            LMEPG.ui.showWaitingDialog("");
            LMEPG.ajax.postAPI("Pay/buildPayUrl", payInfo, function (data) {
                LMEPG.ui.dismissWaitingDialog("");
                if (data.result == "0") {
                    if (data.payUrl.indexOf("http") != -1) {
                        window.location.href = data.payUrl; // 得到支付地址并跳转
                    } else {
                        LMEPG.ui.showToast("获取订购地址异常：" + data.payUrl);
                    }
                } else {
                    LMEPG.ui.showToast("获取订购参数异常：" + data.result);
                }
            });
        }
    };


    //后台数据绑定部分
    var DataHandle = {
        InitData: {
            OrderItem: {$orderItems}
        },
        init: function () {
            if (this.InitData.OrderItem.length > 0) {
                UIHandle.createHtml(this.InitData.OrderItem);
            } else {
                UIHandle.eleList.noData.style.display = "block";
                LMEPG.ButtonManager.init('"', buttons, '', true);
            }

        }
    };

    window.onload = function () {
        DataHandle.init();
    }

</script>
</body>
</html>